@page "/admin"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@inject UserManager<Infrastructure.Identity.ApplicationUser> UserManager
@inject RoleManager<IdentityRole> RoleManager
@rendermode @(new InteractiveServerRenderMode())

<PageTitle>Super Admin - CoreHub</PageTitle>

<div class="admin-container">
    <div class="admin-header">
        <h1><i class="fas fa-user-shield me-2"></i>Super Admin Dashboard</h1>
        <p class="text-muted">Full system access and control</p>
    </div>

    <!-- Stats Cards -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-icon bg-primary">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-content">
                    <h3>@totalUsers</h3>
                    <p>Total Users</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-icon bg-success">
                    <i class="fas fa-user-tie"></i>
                </div>
                <div class="stat-content">
                    <h3>@adminCount</h3>
                    <p>Administrators</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-icon bg-warning">
                    <i class="fas fa-user-check"></i>
                </div>
                <div class="stat-content">
                    <h3>@activeUsers</h3>
                    <p>Active Users</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-icon bg-danger">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <div class="stat-content">
                    <h3>@totalRoles</h3>
                    <p>Total Roles</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <input type="text" class="form-control" @bind="searchQuery" @bind:event="oninput" placeholder="Search by name or email..." />
                </div>
                <div class="col-md-3">
                    <select class="form-select" @bind="roleFilter">
                        <option value="">All Roles</option>
                        @foreach (var role in roles)
                        {
                            <option value="@role.Name">@role.Name</option>
                        }
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" @bind="statusFilter">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-outline-primary w-100" @onclick="ClearFilters">
                        <i class="fas fa-times me-1"></i> Clear
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Users Table -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-users me-2"></i>All Users (@filteredUsers.Count)</h5>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-primary btn-sm" @onclick="ExportToCSV">
                    <i class="fas fa-file-csv me-1"></i> CSV
                </button>
                <button class="btn btn-outline-primary btn-sm" @onclick="ExportToExcel">
                    <i class="fas fa-file-excel me-1"></i> Excel
                </button>
                <button class="btn btn-outline-primary btn-sm" @onclick="ExportToPDF">
                    <i class="fas fa-file-pdf me-1"></i> PDF
                </button>
                <button class="btn btn-primary btn-sm" @onclick="ShowAddUserModal">
                    <i class="fas fa-plus me-1"></i> Add User
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Email</th>
                            <th>Username</th>
                            <th>Roles</th>
                            <th>Created</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var (user, index) in paginatedUsers.Select((u, i) => (u, ((currentUserPage - 1) * usersPerPage) + i + 1)))
                        {
                            <tr>
                                <td>@index</td>
                                <td>@user.Email</td>
                                <td>@user.UserName</td>
                                <td>
                                    @foreach (var role in user.Roles)
                                    {
                                        <span class="badge bg-primary me-1">@role</span>
                                    }
                                </td>
                                <td>@user.CreatedAt.ToString("MMM dd, yyyy")</td>
                                <td>
                                    <span class="badge @(user.IsActive ? "bg-success" : "bg-secondary")">
                                        @(user.IsActive ? "Active" : "Inactive")
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-primary me-1" title="Edit" @onclick="() => EditUser(user)">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" title="Delete" @onclick="() => DeleteUser(user)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            @if (totalUserPages > 1)
            {
                <div class="card-footer">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            Showing @Math.Min((currentUserPage - 1) * usersPerPage + 1, filteredUsers.Count) to @Math.Min(currentUserPage * usersPerPage, filteredUsers.Count) of @filteredUsers.Count users
                        </div>
                        <nav>
                            <ul class="pagination mb-0">
                                <li class="page-item @(currentUserPage == 1 ? "disabled" : "")">
                                    <button class="page-link" @onclick="() => ChangeUserPage(currentUserPage - 1)">Previous</button>
                                </li>
                                @for (int i = 1; i <= totalUserPages; i++)
                                {
                                    var page = i;
                                    <li class="page-item @(currentUserPage == page ? "active" : "")">
                                        <button class="page-link" @onclick="() => ChangeUserPage(page)">@page</button>
                                    </li>
                                }
                                <li class="page-item @(currentUserPage == totalUserPages ? "disabled" : "")">
                                    <button class="page-link" @onclick="() => ChangeUserPage(currentUserPage + 1)">Next</button>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
            }
        </div>
    </div>

    <!-- Roles Section -->
    <div class="card mt-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-shield-alt me-2"></i>System Roles</h5>
            <button class="btn btn-primary btn-sm" @onclick="ShowAddRoleModal">
                <i class="fas fa-plus me-1"></i> Add Role
            </button>
        </div>
        <div class="card-body">
            <div class="row g-3">
                @foreach (var role in roles)
                {
                    <div class="col-md-4">
                        <div class="role-card">
                            <h6>@role.Name</h6>
                            <p class="text-muted small">@role.UserCount users</p>
                            <div class="role-actions">
                                <button class="btn btn-sm btn-outline-primary" @onclick="() => EditRole(role)">Edit</button>
                                <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteRole(role)">Delete</button>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit User Modal -->
@if (showUserModal)
{
    <div class="modal-backdrop show"></div>
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(editingUser == null ? "Add New User" : "Edit User")</h5>
                    <button type="button" class="btn-close" @onclick="CloseUserModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" @bind="userEmail" placeholder="user@corehub.com" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Username</label>
                        <input type="text" class="form-control" @bind="userUsername" placeholder="username" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Roles</label>
                        <select class="form-select" @bind="userRole">
                            <option value="">Select a role</option>
                            @foreach (var role in roles)
                            {
                                <option value="@role.Name">@role.Name</option>
                            }
                        </select>
                    </div>
                    @if (editingUser == null)
                    {
                        <div class="mb-3">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-control" @bind="userPassword" placeholder="Password" />
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseUserModal">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveUser">
                        <i class="fas fa-save me-1"></i> Save
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Add/Edit Role Modal -->
@if (showRoleModal)
{
    <div class="modal-backdrop show"></div>
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(editingRole == null ? "Add New Role" : "Edit Role")</h5>
                    <button type="button" class="btn-close" @onclick="CloseRoleModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Role Name</label>
                        <input type="text" class="form-control" @bind="roleName" placeholder="Role Name" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseRoleModal">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveRole">
                        <i class="fas fa-save me-1"></i> Save
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Delete Confirmation Modal -->
@if (showDeleteModal)
{
    <div class="modal-backdrop show"></div>
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close" @onclick="CloseDeleteModal"></button>
                </div>
                <div class="modal-body">
                    <p>@deleteMessage</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseDeleteModal">Cancel</button>
                    <button type="button" class="btn btn-danger" @onclick="ConfirmDelete">
                        <i class="fas fa-trash me-1"></i> Delete
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<style>
    .admin-container {
        padding: 30px;
    }

    .admin-header {
        margin-bottom: 30px;
    }

    .admin-header h1 {
        font-size: 32px;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 5px;
    }

    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 25px;
        display: flex;
        align-items: center;
        gap: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .stat-icon {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 24px;
    }

    .stat-content h3 {
        font-size: 28px;
        font-weight: 700;
        color: #2c3e50;
        margin: 0;
    }

    .stat-content p {
        color: #7f8c8d;
        margin: 0;
        font-size: 14px;
    }

    .card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .card-header {
        background: white;
        border-bottom: 1px solid #e9ecef;
        padding: 20px;
        border-radius: 12px 12px 0 0;
    }

    .table {
        margin-bottom: 0;
    }

    .table thead th {
        border-bottom: 2px solid #e9ecef;
        color: #2c3e50;
        font-weight: 600;
        padding: 15px;
    }

    .table tbody td {
        padding: 15px;
        vertical-align: middle;
    }

    .role-card {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        border-left: 4px solid #667eea;
    }

    .role-card h6 {
        color: #2c3e50;
        font-weight: 600;
        margin-bottom: 5px;
    }

    .role-actions {
        margin-top: 15px;
        display: flex;
        gap: 10px;
    }

    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1040;
    }

    .modal.show {
        z-index: 1050;
    }
</style>

@code {
    private int totalUsers = 15;
    private int adminCount = 3;
    private int activeUsers = 12;
    private int totalRoles = 5;

    private List<UserDto> users = new();
    private List<RoleDto> roles = new();

    // Pagination
    private int currentUserPage = 1;
    private const int usersPerPage = 4;
    private List<UserDto> filteredUsers => FilterUsers();
    private List<UserDto> paginatedUsers => filteredUsers.Skip((currentUserPage - 1) * usersPerPage).Take(usersPerPage).ToList();
    private int totalUserPages => (int)Math.Ceiling(filteredUsers.Count / (double)usersPerPage);

    // Search and Filters
    private string searchQuery = "";
    private string roleFilter = "";
    private string statusFilter = "";

    // Modal states
    private bool showUserModal = false;
    private bool showRoleModal = false;
    private bool showDeleteModal = false;
    private UserDto? editingUser = null;
    private RoleDto? editingRole = null;
    private string deleteMessage = "";
    private Action? deleteAction;

    // Form fields
    private string userEmail = "";
    private string userUsername = "";
    private string userRole = "";
    private string userPassword = "";
    private string roleName = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        // Dummy data for now
        users = new List<UserDto>
        {
            new() { Email = "admin@corehub.com", UserName = "admin", Roles = new List<string> { "SuperAdmin", "Admin" }, CreatedAt = DateTime.Now.AddDays(-365), IsActive = true },
            new() { Email = "john.doe@corehub.com", UserName = "john.doe", Roles = new List<string> { "Manager" }, CreatedAt = DateTime.Now.AddDays(-180), IsActive = true },
            new() { Email = "jane.smith@corehub.com", UserName = "jane.smith", Roles = new List<string> { "Practitioner" }, CreatedAt = DateTime.Now.AddDays(-90), IsActive = true },
            new() { Email = "bob.wilson@corehub.com", UserName = "bob.wilson", Roles = new List<string> { "Practitioner" }, CreatedAt = DateTime.Now.AddDays(-60), IsActive = true },
            new() { Email = "alice.johnson@corehub.com", UserName = "alice.johnson", Roles = new List<string> { "User" }, CreatedAt = DateTime.Now.AddDays(-30), IsActive = true },
            new() { Email = "charlie.brown@corehub.com", UserName = "charlie.brown", Roles = new List<string> { "Manager" }, CreatedAt = DateTime.Now.AddDays(-120), IsActive = true },
            new() { Email = "diana.prince@corehub.com", UserName = "diana.prince", Roles = new List<string> { "Admin" }, CreatedAt = DateTime.Now.AddDays(-200), IsActive = true },
            new() { Email = "peter.parker@corehub.com", UserName = "peter.parker", Roles = new List<string> { "Practitioner" }, CreatedAt = DateTime.Now.AddDays(-45), IsActive = false },
            new() { Email = "tony.stark@corehub.com", UserName = "tony.stark", Roles = new List<string> { "Admin" }, CreatedAt = DateTime.Now.AddDays(-300), IsActive = true },
            new() { Email = "bruce.wayne@corehub.com", UserName = "bruce.wayne", Roles = new List<string> { "Practitioner" }, CreatedAt = DateTime.Now.AddDays(-75), IsActive = true },
            new() { Email = "clark.kent@corehub.com", UserName = "clark.kent", Roles = new List<string> { "Manager" }, CreatedAt = DateTime.Now.AddDays(-150), IsActive = true },
            new() { Email = "barry.allen@corehub.com", UserName = "barry.allen", Roles = new List<string> { "User" }, CreatedAt = DateTime.Now.AddDays(-20), IsActive = true },
            new() { Email = "hal.jordan@corehub.com", UserName = "hal.jordan", Roles = new List<string> { "Practitioner" }, CreatedAt = DateTime.Now.AddDays(-100), IsActive = false },
            new() { Email = "arthur.curry@corehub.com", UserName = "arthur.curry", Roles = new List<string> { "User" }, CreatedAt = DateTime.Now.AddDays(-15), IsActive = true },
            new() { Email = "oliver.queen@corehub.com", UserName = "oliver.queen", Roles = new List<string> { "Practitioner" }, CreatedAt = DateTime.Now.AddDays(-80), IsActive = true }
        };

        roles = new List<RoleDto>
        {
            new() { Name = "SuperAdmin", UserCount = 1 },
            new() { Name = "Admin", UserCount = 3 },
            new() { Name = "Manager", UserCount = 3 },
            new() { Name = "Practitioner", UserCount = 6 },
            new() { Name = "User", UserCount = 2 }
        };

        await Task.CompletedTask;
    }

    // User Modal Methods
    private void ShowAddUserModal()
    {
        editingUser = null;
        userEmail = "";
        userUsername = "";
        userRole = "";
        userPassword = "";
        showUserModal = true;
    }

    private void EditUser(UserDto user)
    {
        editingUser = user;
        userEmail = user.Email;
        userUsername = user.UserName;
        userRole = user.Roles.FirstOrDefault() ?? "";
        userPassword = "";
        showUserModal = true;
    }

    private void CloseUserModal()
    {
        showUserModal = false;
        editingUser = null;
    }

    private async Task SaveUser()
    {
        if (editingUser == null)
        {
            // Add new user
            var newUser = new UserDto
            {
                Email = userEmail,
                UserName = userUsername,
                Roles = new List<string> { userRole },
                CreatedAt = DateTime.Now,
                IsActive = true
            };
            users.Add(newUser);
            totalUsers++;
        }
        else
        {
            // Update existing user
            editingUser.Email = userEmail;
            editingUser.UserName = userUsername;
            editingUser.Roles = new List<string> { userRole };
        }

        CloseUserModal();
        await Task.CompletedTask;
    }

    private void DeleteUser(UserDto user)
    {
        deleteMessage = $"Are you sure you want to delete user '{user.Email}'? This action cannot be undone.";
        deleteAction = () =>
        {
            users.Remove(user);
            totalUsers--;
        };
        showDeleteModal = true;
    }

    // Role Modal Methods
    private void ShowAddRoleModal()
    {
        editingRole = null;
        roleName = "";
        showRoleModal = true;
    }

    private void EditRole(RoleDto role)
    {
        editingRole = role;
        roleName = role.Name;
        showRoleModal = true;
    }

    private void CloseRoleModal()
    {
        showRoleModal = false;
        editingRole = null;
    }

    private async Task SaveRole()
    {
        if (editingRole == null)
        {
            // Add new role
            var newRole = new RoleDto
            {
                Name = roleName,
                UserCount = 0
            };
            roles.Add(newRole);
            totalRoles++;
        }
        else
        {
            // Update existing role
            editingRole.Name = roleName;
        }

        CloseRoleModal();
        await Task.CompletedTask;
    }

    private void DeleteRole(RoleDto role)
    {
        deleteMessage = $"Are you sure you want to delete role '{role.Name}'? This will affect {role.UserCount} user(s).";
        deleteAction = () =>
        {
            roles.Remove(role);
            totalRoles--;
        };
        showDeleteModal = true;
    }

    // Delete Modal Methods
    private void CloseDeleteModal()
    {
        showDeleteModal = false;
        deleteMessage = "";
        deleteAction = null;
    }

    private void ConfirmDelete()
    {
        deleteAction?.Invoke();
        CloseDeleteModal();
    }

    // Pagination
    private void ChangeUserPage(int page)
    {
        if (page >= 1 && page <= totalUserPages)
        {
            currentUserPage = page;
        }
    }

    // Filter and Search
    private List<UserDto> FilterUsers()
    {
        var filtered = users.AsEnumerable();

        if (!string.IsNullOrWhiteSpace(searchQuery))
        {
            filtered = filtered.Where(u => 
                u.Email.Contains(searchQuery, StringComparison.OrdinalIgnoreCase) ||
                u.UserName.Contains(searchQuery, StringComparison.OrdinalIgnoreCase));
        }

        if (!string.IsNullOrWhiteSpace(roleFilter))
        {
            filtered = filtered.Where(u => u.Roles.Contains(roleFilter));
        }

        if (!string.IsNullOrWhiteSpace(statusFilter))
        {
            filtered = filtered.Where(u => 
                statusFilter == "active" ? u.IsActive : !u.IsActive);
        }

        return filtered.ToList();
    }

    private void ClearFilters()
    {
        searchQuery = "";
        roleFilter = "";
        statusFilter = "";
        currentUserPage = 1;
    }

    // Export Functions
    private void ExportToCSV()
    {
        // Placeholder for CSV export
        Console.WriteLine("Exporting to CSV...");
    }

    private void ExportToExcel()
    {
        // Placeholder for Excel export
        Console.WriteLine("Exporting to Excel...");
    }

    private void ExportToPDF()
    {
        // Placeholder for PDF export
        Console.WriteLine("Exporting to PDF...");
    }

    public class UserDto
    {
        public string Email { get; set; } = "";
        public string UserName { get; set; } = "";
        public List<string> Roles { get; set; } = new();
        public DateTime CreatedAt { get; set; }
        public bool IsActive { get; set; }
    }

    public class RoleDto
    {
        public string Name { get; set; } = "";
        public int UserCount { get; set; }
    }
}
